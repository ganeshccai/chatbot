<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Agent Interface</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: Arial, sans-serif; background: #f4f7f9; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
  header { background: linear-gradient(90deg, #ff5f6d, #ffc371); color: white; padding: 12px; text-align: center; font-size: 20px; font-weight: bold; border-bottom: 2px solid #ff9a9e; border-radius: 0 0 15px 15px; }
  #online-status { text-align: center; font-size: 16px; padding: 6px; font-weight: bold; background: #fff; border-bottom: 1px solid #eee; }
  #live-typing { text-align: center; font-size: 14px; color: #ff69b4; padding: 4px; font-style: italic; min-height: 24px; background: #fff; border-bottom: 1px solid #eee; }
  #chat-container { flex: 1; display: flex; flex-direction: column; padding: 10px; padding-bottom: 90px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
  .message { max-width: 80%; margin: 6px 0; padding: 8px 12px; border-radius: 12px; word-wrap: break-word; }
  .user-msg { background: #ffc0cb; align-self: flex-start; }
  .agent-msg { background: #ffffff; border: 1px solid #ddd; align-self: flex-end; }
  #input-container { position: fixed; bottom: 0; left: 0; right: 0; display: flex; padding: 10px; background: #fff; border-top: 1px solid #ccc; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.08); }
  #msg { flex: 1; padding: 10px 14px; border-radius: 20px; border: 1px solid #ccc; font-size: 16px; outline: none; }
  #msg:focus { border-color: #ff5f6d; }
  #send-btn { margin-left: 8px; padding: 10px 20px; border: none; background: linear-gradient(90deg, #ff5f6d, #ffc371); color: white; border-radius: 20px; font-size: 16px; cursor: pointer; min-width: 70px; }
  #send-btn:active { opacity: 0.9; }
  @media (max-width: 600px) { #msg { font-size: 16px; } #send-btn { font-size: 16px; padding: 10px 16px; } }
</style>
</head>
<body data-chat-id="1234">

<header>Agent Interface</header>
<div id="online-status">User Offline ðŸ”´</div>
<div id="live-typing"></div>

<div id="chat-container" aria-live="polite"></div>

<div id="input-container">
  <input id="msg" placeholder="Type reply..." autocomplete="off">
  <button id="send-btn">Send</button>
</div>

<script>
// BACKEND_URL: set to your Cloud Run or backend origin when deployed (no trailing slash)
const BACKEND_URL = window.__BACKEND_URL__ || ""; // e.g. "https://my-service-xxxxx.a.run.app"
const chatId = document.body.dataset.chatId || "1234";

// helpers
function withBackend(path){ return BACKEND_URL ? `${BACKEND_URL}${path}` : path; }
function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }

// DOM
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send-btn');
const chatContainer = document.getElementById('chat-container');
const onlineStatus = document.getElementById('online-status');
const liveTypingElem = document.getElementById('live-typing');

// send message to backend
async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  try{
    const res = await fetch(withBackend(`/send`), {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: chatId, sender: 'agent', text })
    });
    if(!res.ok) throw new Error('Send failed '+res.status);
    msgInput.value = '';
    // clear live typing on send
    await sendLiveTyping('');
    await loadMessages();
  }catch(err){ console.error('sendMessage error:', err); }
}

// load messages
async function loadMessages(){
  try{
    const res = await fetch(withBackend(`/messages/${chatId}`));
    if(!res.ok) return;
    const data = await res.json();
    chatContainer.innerHTML = '';
    data.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.sender === 'user' ? 'user-msg' : 'agent-msg');
      div.textContent = msg.text || '';
      chatContainer.appendChild(div);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }catch(err){ console.error('loadMessages error:', err); }
}

// typing (debounced)
const sendLiveTypingDebounced = debounce(async (text)=>{
  await sendLiveTyping(text);
}, 300);

async function sendLiveTyping(text){
  try{
    await fetch(withBackend(`/live_typing`), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: chatId, sender: 'agent', text })
    });
  }catch(err){ console.error('sendLiveTyping error:', err); }
}

// load live typing status
async function loadLiveTyping(){
  try{
    const res = await fetch(withBackend(`/get_live_typing/${chatId}`));
    if(!res.ok) return;
    const data = await res.json();
    if(data && data.text){
      const who = data.sender || 'User';
      liveTypingElem.textContent = `${who} typing: ${data.text}`;
    } else {
      liveTypingElem.textContent = '';
    }
  }catch(err){ console.error('loadLiveTyping error:', err); }
}

// online checks
async function markOnline(){
  try{
    await fetch(withBackend(`/mark_online`), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: chatId, sender: 'agent' })
    });
  }catch(err){ console.error('markOnline error:', err); }
}

async function checkOnline(){
  try{
    const res = await fetch(withBackend(`/is_online/${chatId}`));
    if(!res.ok) return;
    const data = await res.json();
    const online = !!data.user_online;
    onlineStatus.textContent = online ? 'User Online ðŸŸ¢' : 'User Offline ðŸ”´';
  }catch(err){ console.error('checkOnline error:', err); }
}

// graceful logout on unload
window.addEventListener('beforeunload', ()=>{
  try{
    const data = JSON.stringify({ chat_id: chatId, sender: 'agent' });
    const blob = new Blob([data], { type: 'application/json' });
    navigator.sendBeacon(withBackend(`/logout_agent`), blob);
  }catch(err){ /* ignore */ }
});

// events
sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});
msgInput.addEventListener('input', (e)=>{ sendLiveTypingDebounced(e.target.value); });

// polling intervals (throttled)
setInterval(loadMessages, 2000);
setInterval(checkOnline, 3000);
setInterval(loadLiveTyping, 500);
setInterval(markOnline, 10000);

// initial
markOnline(); checkOnline(); loadMessages();

</script>

</body>
</html>
