<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Panel</title>
<style>
html, body {height:100%; margin:0; font-family:Arial,sans-serif; display:flex; flex-direction:column;}
header {background:linear-gradient(90deg,#ff5f6d,#ffc371,#ff9a9e,#f77062); color:white; padding:12px; text-align:center; font-size:20px; font-weight:bold; border-bottom:2px solid #ff9a9e; border-radius:0 0 15px 15px;}
#online-status,#ticket-status,#live-typing {text-align:center; margin-top:6px;}
#online-status {color:#28a745; font-weight:bold; font-size:15px;}
#ticket-status {color:#333; font-size:14px; font-weight:bold;}
#live-typing {color:#ff69b4; font-style:italic;}
#chat-container {flex:1; display:flex; flex-direction:column; padding:10px; overflow-y:auto;}
.message {max-width:80%; margin:4px 0; padding:8px 12px; border-radius:12px; white-space:pre-wrap; word-wrap:break-word;}
.user-msg {background:#ffc0cb; align-self:flex-start;}
.agent-msg {background:#fff; border:1px solid #ddd; align-self:flex-end;}
.seen-indicator {display:block; font-size:12px; color:#666; margin-top:4px; text-align:right;}
#input-container {flex-shrink:0; display:flex; padding:10px; background:#fff; border-top:1px solid #ccc;}
#msg {flex:1; padding:8px 12px; border-radius:20px; border:1px solid #ccc; font-size:14px; resize:none;}
#send-btn {margin-left:8px; padding:8px 16px; border:none; background:linear-gradient(90deg,#ff5f6d,#ffc371); color:white; border-radius:20px; font-size:14px; cursor:pointer;}
#send-btn:active {opacity:0.8;}
</style>
</head>
<body>
<header>Agent Panel</header>
<div id="online-status">User Offline ‚ùå</div>
<div id="ticket-status">Ticket: Unread</div>
<div id="live-typing"></div>
<div id="chat-container"></div>
<div id="input-container">
  <textarea id="msg" placeholder="Type message..." rows="2"></textarea>
  <button id="send-btn" type="button">Send</button>
</div>
<script>
const baseUrl = "https://chatbot-788207962975.us-central1.run.app";
const chatId = "1234";
const localRole = 'agent';
const chatContainer = document.getElementById("chat-container");
const msgInput = document.getElementById("msg");
const ticketStatusEl = document.getElementById('ticket-status');
const onlineStatusEl = document.getElementById('online-status');
const liveTypingEl = document.getElementById('live-typing');

let lastIndex = 0;

// Clear chat on load
chatContainer.innerHTML='';

// Append message function
function appendMessage(msg,index){
  if(chatContainer.querySelector(`[data-index='${index}']`)) return;
  const div=document.createElement('div');
  div.className='message '+(msg.sender==='user'?'user-msg':'agent-msg');
  div.textContent=msg.text;
  div.dataset.index=index;
  if(msg.seen_by && msg.seen_by.includes('agent')){
    const span=document.createElement('span');
    span.className='seen-indicator';
    span.textContent='Seen';
    div.appendChild(span);
    ticketStatusEl.textContent='Ticket: Read ‚úÖ';
  }
  chatContainer.appendChild(div);
  chatContainer.scrollTop=chatContainer.scrollHeight;
}

// Send agent message
async function sendMessage(){
  const text=msgInput.value.trim();
  if(!text) return;
  await fetch(`${baseUrl}/send`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,sender:'agent',text})
  });
  appendMessage({sender:'agent',text,seen_by:[]},lastIndex);
  lastIndex++;
  msgInput.value='';
  ticketStatusEl.textContent='Ticket: Unread';
}

// SSE for real-time updates
const es=new EventSource(`${baseUrl}/events/${chatId}`);
es.onmessage=e=>{
  try{
    const data=JSON.parse(e.data);
    if(data.type==='new_message'){
      appendMessage(data.message,lastIndex);
      lastIndex++;
    }else if(data.type==='read'){
      if(data.seen_by.includes('agent')){
        const el=chatContainer.querySelector(`[data-index='${data.index}']`);
        if(el && !el.querySelector('.seen-indicator')){
          const span=document.createElement('span');
          span.className='seen-indicator';
          span.textContent='Seen';
          el.appendChild(span);
        }
        ticketStatusEl.textContent='Ticket: Read ‚úÖ';
      }
    }
  }catch(err){}
};

// Check user online
async function checkOnline(){
  const res=await fetch(`${baseUrl}/is_online/${chatId}`);
  const data=await res.json();
  onlineStatusEl.textContent=data.user_online?'User Online üü¢':'User Offline ‚ùå';
}

// Load live typing (only for agent)
async function loadLiveTyping(){
  const res=await fetch(`${baseUrl}/get_live_typing/${chatId}`);
  const data=await res.json();
  liveTypingEl.textContent=data.text?`Typing: ${data.text}`:'';
}

// Event listeners
document.getElementById("send-btn").addEventListener("click",sendMessage);
msgInput.addEventListener("keydown",e=>{
  if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); sendMessage();}
});

// Logout agent
window.addEventListener("beforeunload",async()=>{
  await fetch(`${baseUrl}/logout_agent`,{method:"POST",headers:{"Content-Type":"application/json"}});
});

// Intervals
setInterval(checkOnline,500);
setInterval(loadLiveTyping,500);

checkOnline();
loadLiveTyping();
</script>
</body>
</html>
