<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Agent Interface ðŸ’¬</title>
<style>
  body { font-family: Arial; margin:0; display:flex; flex-direction:column; height:100vh; }
  header { background:#ff5f6d; color:white; padding:10px; text-align:center; font-weight:bold; position:relative; }
  #user-status { position:absolute; right:10px; top:10px; font-weight:bold; }
  #typing-indicator { font-style:italic; text-align:center; min-height:20px; color:#ff69b4; }
  #chat-container { flex:1; overflow-y:auto; padding:10px; }
  .message { margin:5px; padding:8px; border-radius:8px; max-width:70%; }
  .user-msg { background:#ffc0cb; align-self:flex-start; }
  .agent-msg { background:#eee; align-self:flex-end; }
  #input-container { display:flex; padding:10px; border-top:1px solid #ccc; gap:6px; }
  textarea { flex:1; resize:none; border-radius:10px; padding:8px; }
  button { padding:8px 12px; background:#ff5f6d; color:white; border:none; border-radius:10px; cursor:pointer; }
</style>
</head>
<body data-chat-id="1234">
<header>Agent ðŸ’¬ <span id="user-status">ðŸ”´</span></header>
<div id="typing-indicator"></div>
<div id="chat-container"></div>
<div id="input-container">
  <textarea id="msg" rows="2" placeholder="Type reply..."></textarea>
  <button id="send-btn">Send</button>
  <button id="clear-btn">Clear</button>
</div>

<script>
const BACKEND_URL="https://chatbot-788207962975.us-central1.run.app";
const chatId=document.body.dataset.chatId;
const msgInput=document.getElementById("msg");
const chat=document.getElementById("chat-container");
const typing=document.getElementById("typing-indicator");
const userStatus=document.getElementById("user-status");

async function sendMessage(){
  const text=msgInput.value.trim(); if(!text) return;
  await fetch(`${BACKEND_URL}/send`,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,sender:"agent",text})});
  msgInput.value=""; await sendTyping("");
  loadMessages();
}

async function loadMessages(){
  const res=await fetch(`${BACKEND_URL}/messages/${chatId}`); const data=await res.json();
  chat.innerHTML=""; data.forEach(m=>{
    const d=document.createElement("div");
    d.className="message "+(m.sender==="user"?"user-msg":"agent-msg");
    d.textContent=m.text; chat.appendChild(d);
  }); chat.scrollTop=chat.scrollHeight;
}

async function sendTyping(text){
  await fetch(`${BACKEND_URL}/live_typing`,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,sender:"agent",text})});
}

async function loadTyping(){
  const res=await fetch(`${BACKEND_URL}/get_live_typing/${chatId}`); const d=await res.json();
  typing.textContent=(d.sender==="user"&&d.text)?`User typing: ${d.text}`:"";
}

async function checkStatus(){
  const res=await fetch(`${BACKEND_URL}/is_online/${chatId}`); const d=await res.json();
  userStatus.textContent=d.user_online?"ðŸŸ¢":"ðŸ”´";
}

async function clearChat(){
  await fetch(`${BACKEND_URL}/clear_chat/${chatId}`,{method:"POST"});
  chat.innerHTML="";
}

async function markOnline(){
  await fetch(`${BACKEND_URL}/mark_online`,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,sender:"agent"})});
}

window.addEventListener("beforeunload", ()=>{
  const data=JSON.stringify({chat_id:chatId,sender:"agent"});
  const blob=new Blob([data],{type:"application/json"});
  navigator.sendBeacon(`${BACKEND_URL}/logout_agent`, blob);
});

msgInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});
msgInput.addEventListener("input",e=>sendTyping(e.target.value));
document.getElementById("send-btn").onclick=sendMessage;
document.getElementById("clear-btn").onclick=clearChat;

// Polling
setInterval(loadMessages,1000);
setInterval(checkStatus,1000);
setInterval(loadTyping,500);
setInterval(markOnline,10000);

// Initial
checkStatus(); loadMessages(); loadTyping(); markOnline();
</script>
</body>
</html>
