<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Panel</title>
<style>
html,body{height:100%;margin:0;font-family:Arial,sans-serif;display:flex;flex-direction:column;}
header{background:linear-gradient(90deg,#ff5f6d,#ffc371,#ff9a9e,#f77062);color:white;padding:12px;text-align:center;font-size:20px;font-weight:bold;border-bottom:2px solid #ff9a9e;border-radius:0 0 15px 15px;}
#online-status,#ticket-status,#live-typing{text-align:center;margin-top:6px;}
#online-status{color:#28a745;font-weight:bold;font-size:15px;}
#ticket-status{color:#333;font-size:14px;font-weight:bold;}
#live-typing{color:#ff69b4;font-style:italic;}
#chat-container{flex:1;display:flex;flex-direction:column;padding:10px;overflow-y:auto;}
.message{max-width:80%;margin:4px 0;padding:8px 12px;border-radius:12px;white-space:pre-wrap;word-wrap:break-word;}
.user-msg{background:#ffc0cb;align-self:flex-start;}
.agent-msg{background:#fff;border:1px solid #ddd;align-self:flex-end;}
.seen-indicator{display:block;font-size:12px;color:#666;margin-top:4px;text-align:right;}
#input-container{flex-shrink:0;display:flex;padding:10px;background:#fff;border-top:1px solid #ccc;}
#msg{flex:1;padding:8px 12px;border-radius:20px;border:1px solid #ccc;font-size:14px;resize:none;}
#send-btn{margin-left:8px;padding:8px 16px;border:none;background:linear-gradient(90deg,#ff5f6d,#ffc371);color:white;border-radius:20px;font-size:14px;cursor:pointer;}
#send-btn:active{opacity:0.8;}
</style>
</head>
<body>
<header>Agent Panel</header>
<div id="online-status">User Offline ‚ùå</div>
<div id="ticket-status">Ticket: Unread</div>
<div id="live-typing"></div>
<div id="chat-container"></div>
<div id="input-container">
  <textarea id="msg" placeholder="Type message..." rows="2"></textarea>
  <button id="send-btn" type="button">Send</button>
</div>

<script>
const baseUrl = "";  // ‚úÖ empty for same origin (local Flask)
const chatId = "1234";
const sender = "agent";

const chatContainer = document.getElementById("chat-container");
const msgInput = document.getElementById("msg");
const ticketStatusEl = document.getElementById("ticket-status");
const onlineStatusEl = document.getElementById("online-status");
const liveTypingEl = document.getElementById("live-typing");

function appendMessage(msg){
  const div = document.createElement("div");
  div.className = "message " + (msg.sender==="user" ? "user-msg" : "agent-msg");
  div.textContent = msg.text;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// send message
async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  msgInput.value = "";
  await fetch(`${baseUrl}/send`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId, sender, text})
  });
}

// SSE - receive
const es = new EventSource(`${baseUrl}/events/${chatId}`);
es.onmessage = (e)=>{
  try {
    const data = JSON.parse(e.data);
    if(data.type === "new_message"){
      appendMessage(data.message);
    }
  } catch(err){ console.log(err); }
};

// Load existing messages
async function loadMessages(){
  const res = await fetch(`${baseUrl}/messages/${chatId}`);
  const msgs = await res.json();
  chatContainer.innerHTML="";
  msgs.forEach(m => appendMessage(m));
}

// online check
async function checkOnline(){
  const res = await fetch(`${baseUrl}/is_online/${chatId}`);
  const data = await res.json();
  onlineStatusEl.textContent = data.user_online ? "User Online üü¢" : "User Offline ‚ùå";
}

// typing
async function loadLiveTyping(){
  const res = await fetch(`${baseUrl}/get_live_typing/${chatId}`);
  const data = await res.json();
  liveTypingEl.textContent = data.text ? `Typing: ${data.text}` : "";
}

document.getElementById("send-btn").addEventListener("click", sendMessage);
msgInput.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});

window.addEventListener("beforeunload", async ()=> {
  await fetch(`${baseUrl}/logout_agent`, {method:"POST"});
});

// intervals
setInterval(checkOnline, 1000);
setInterval(loadLiveTyping, 500);
loadMessages();
checkOnline();
loadLiveTyping();
</script>
</body>
</html>
