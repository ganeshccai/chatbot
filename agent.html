<!-- agent.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Agent Interface ðŸ’¬</title>
<style>
  :root {
    --accent: #3b82f6; /* blue */
    --accent2: #2563eb;
    --bg: #f3f6fb;
    --bubble-user: #ffffff;
    --bubble-agent: #dbeafe; /* light blue */
    --user-border: #dcdcdc;
  }
  body { font-family: Arial, sans-serif; margin:0; display:flex; flex-direction:column; height:100vh; background:var(--bg); }
  header { background: linear-gradient(90deg, var(--accent), var(--accent2)); color:white; padding:12px; text-align:center; font-weight:bold; position:relative; border-bottom:2px solid var(--accent2); }
  #user-status { position:absolute; right:12px; top:12px; font-weight:bold; }
  #typing-indicator { font-style:italic; text-align:center; min-height:24px; color:#2563eb; background:#fff; padding:6px 8px; border-bottom:1px solid #eee; }
  #chat-container { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; }
  .message { margin:6px 0; padding:10px 14px; border-radius:14px; max-width:80%; word-wrap:break-word; }
  /* Agent window: user LEFT, agent RIGHT */
  .user-msg { background:var(--bubble-user); border:1px solid var(--user-border); align-self:flex-start; }
  .agent-msg { background:var(--bubble-agent); align-self:flex-end; }
  #input-container { display:flex; gap:8px; padding:10px; background:#fff; border-top:1px solid #ccc; }
  #msg { flex:1; resize:none; border-radius:14px; padding:10px 12px; border:1px solid #ccc; font-size:16px; outline:none; }
  #msg:focus { border-color: var(--accent); }
  button { padding:10px 16px; background:var(--accent); color:white; border:none; border-radius:14px; cursor:pointer; font-size:16px; }
  button:active { opacity:0.9; }
</style>
</head>
<body data-chat-id="1234">
<header>Agent ðŸ’¬ <span id="user-status">ðŸ”´</span></header>

<div id="typing-indicator" aria-live="polite"></div>
<div id="chat-container" aria-live="polite"></div>

<div id="input-container">
  <textarea id="msg" rows="2" placeholder="Type reply..." autocomplete="off"></textarea>
  <button id="send-btn">Send</button>
  <button id="clear-btn">Clear</button>
</div>

<script>
const BACKEND_URL = "https://chatbot-788207962975.us-central1.run.app";
const chatId = document.body.dataset.chatId || "1234";

const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-btn");
const chatContainer = document.getElementById("chat-container");
const typingIndicator = document.getElementById("typing-indicator");
const userStatus = document.getElementById("user-status");

async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  try{
    const res = await fetch(`${BACKEND_URL}/send`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ chat_id: chatId, sender: "agent", text })
    });
    if(!res.ok) throw new Error("Send failed");
    msgInput.value = "";
    await sendTyping(""); // clear live typing
    await loadMessages(); // show immediately
  }catch(e){ console.error("sendMessage error:", e); }
}

async function loadMessages(){
  try{
    const res = await fetch(`${BACKEND_URL}/messages/${chatId}`);
    if(!res.ok) return;
    const data = await res.json();
    chatContainer.innerHTML = "";
    data.forEach(m=>{
      const d = document.createElement("div");
      // On AGENT window: user left, agent right
      d.className = "message " + (m.sender==="user" ? "user-msg" : "agent-msg");
      d.textContent = m.text || "";
      chatContainer.appendChild(d);
    });
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }catch(e){ console.error("loadMessages error:", e); }
}

async function sendTyping(text){
  try{
    await fetch(`${BACKEND_URL}/live_typing`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ chat_id: chatId, sender: "agent", text })
    });
  }catch(e){ console.error("sendTyping error:", e); }
}

async function loadTyping(){
  try{
    const res = await fetch(`${BACKEND_URL}/get_live_typing/${chatId}`);
    if(!res.ok) return;
    const d = await res.json();
    typingIndicator.textContent = (d.sender === "user" && d.text) ? `User typing: ${d.text}` : "";
  }catch(e){ console.error("loadTyping error:", e); }
}

async function checkStatus(){
  try{
    const res = await fetch(`${BACKEND_URL}/is_online/${chatId}`);
    if(!res.ok) return;
    const d = await res.json();
    userStatus.textContent = d.user_online ? "ðŸŸ¢" : "ðŸ”´";
  }catch(e){ console.error("checkStatus error:", e); }
}

async function clearChat(){
  try{
    await fetch(`${BACKEND_URL}/clear_chat/${chatId}`, { method:"POST" });
    chatContainer.innerHTML = "";
  }catch(e){ console.error("clearChat error:", e); }
}

async function markOnline(){
  try{
    await fetch(`${BACKEND_URL}/mark_online`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ chat_id: chatId, sender: "agent" })
    });
  }catch(e){ console.error("markOnline error:", e); }
}

sendBtn.addEventListener("click", sendMessage);
clearBtn.addEventListener("click", clearChat);
msgInput.addEventListener("keydown", (e)=>{
  if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});
msgInput.addEventListener("input", (e)=>{ sendTyping(e.target.value); });

// Fast polling and heartbeat
setInterval(loadMessages, 1000);
setInterval(checkStatus, 1000);
setInterval(loadTyping, 500);
setInterval(markOnline, 10000);

// Initial
markOnline();
checkStatus();
loadMessages();
loadTyping();

// Logout on close
window.addEventListener("beforeunload", ()=>{
  try{
    const data = JSON.stringify({ chat_id: chatId, sender: "agent" });
    const blob = new Blob([data], { type:"application/json" });
    navigator.sendBeacon(`${BACKEND_URL}/logout_agent`, blob);
  }catch(e){}
});
</script>
</body>
</html>

