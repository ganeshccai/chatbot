<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CCAI Agent Dashboard</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    document.addEventListener("DOMContentLoaded", async () => {
      // âœ… Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyABXXFFamtW5rjBZGqe-2uyR2CoWIyzDG4",
        authDomain: "project001-474715.firebaseapp.com",
        projectId: "project001-474715",
        storageBucket: "project001-474715.firebasestorage.app",
        messagingSenderId: "788207962975",
        appId: "1:788207962975:web:f9ff0a07f72df289cc84ea"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const sessionList = document.getElementById("session-list");
      const chatBox = document.getElementById("chat-box");
      const input = document.getElementById("message");
      let currentSession = null;

      console.log("âœ… Agent dashboard connected to Firestore");

      // ðŸ” Show all sessions live
      onSnapshot(collection(db, "sessions"), (snapshot) => {
        sessionList.innerHTML = "";
        snapshot.forEach(docSnap => {
          const li = document.createElement("li");
          li.textContent = docSnap.id;
          li.style.cursor = "pointer";
          li.onclick = () => loadChat(docSnap.id);
          sessionList.appendChild(li);
        });
      });

      // ðŸ”¹ Load selected chat session
      function loadChat(sessionId) {
        currentSession = sessionId;
        chatBox.innerHTML = "";
        console.log("ðŸ“‚ Viewing session:", sessionId);

        const q = query(collection(db, "sessions", sessionId, "messages"), orderBy("timestamp"));
        onSnapshot(q, (snapshot) => {
          chatBox.innerHTML = "";
          snapshot.forEach(docSnap => {
            const msg = docSnap.data();
            const div = document.createElement("div");
            div.classList.add("message", msg.sender);
            div.textContent = `${msg.sender}: ${msg.message}`;
            chatBox.appendChild(div);
          });
          chatBox.scrollTop = chatBox.scrollHeight;
        });
      }

      // ðŸ“¨ Send reply to Cloud Run webhook
      window.sendReply = async function () {
        const text = input.value.trim();
        if (!text || !currentSession) return alert("Select a session first!");

        console.log("ðŸ“¤ Sending reply to:", currentSession);

        await fetch("https://chatbot-788207962975.us-central1.run.app/agent-reply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ session: currentSession, message: text })
        });

        input.value = "";
      };
    });
  </script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: #f5f7fa;
      display: flex;
      height: 100vh;
      margin: 0;
    }

    .sessions {
      width: 250px;
      background: #fff;
      border-right: 1px solid #ddd;
      overflow-y: auto;
      padding: 10px;
    }

    ul { list-style: none; padding: 0; margin: 0; }
    li {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    li:hover { background: #f0f0f0; }

    .chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #fff;
    }

    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .message { margin: 5px 0; padding: 8px 10px; border-radius: 6px; }
    .user { background: #d1e7dd; margin-left: auto; }
    .agent { background: #f8d7da; margin-right: auto; }

    .input-row {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
    }

    input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      margin-left: 10px;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="sessions">
    <h3>ðŸ’¬ User Sessions</h3>
    <ul id="session-list"></ul>
  </div>

  <div class="chat">
    <div class="chat-box" id="chat-box"></div>
    <div class="input-row">
      <input id="message" placeholder="Type agent reply..." />
      <button onclick="sendReply()">Send</button>
    </div>
  </div>
</body>
</html>
