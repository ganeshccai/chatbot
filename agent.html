<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Agent Interface ðŸ’¬</title>
<style>
  * { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    background: #f4f7f9;
    margin: 0; padding: 0;
    display: flex; flex-direction: column;
    height: 100vh; overflow: hidden;
  }
  header {
    background: linear-gradient(90deg, #ff5f6d, #ffc371, #ff9a9e, #f77062);
    color: white; padding: 12px; text-align: center;
    font-size: 20px; font-weight: bold;
    border-bottom: 2px solid #ff9a9e;
    border-radius: 0 0 15px 15px;
    position: relative; z-index: 10;
  }
  #user-status {
    position: absolute; top: 12px; right: 12px;
    font-weight: bold; font-size: 18px;
  }
  #typing-indicator {
    text-align: center; font-size: 14px; color: #ff69b4;
    font-style: italic; padding: 4px; min-height: 24px;
    background: #fff; border-bottom: 1px solid #eee;
  }
  #chat-container {
    flex: 1; display: flex; flex-direction: column;
    padding: 10px; padding-bottom: 90px;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
  }
  .message {
    max-width: 80%; margin: 4px 0; padding: 8px 12px;
    border-radius: 12px; word-wrap: break-word;
  }
  .user-msg { background: #ffc0cb; align-self: flex-start; }
  .agent-msg { background: #ffffff; border: 1px solid #ddd; align-self: flex-end; }

  #input-container {
    position: fixed; bottom: 0; left: 0; right: 0;
    display: flex; gap: 8px;
    padding: 10px; background: #fff;
    border-top: 1px solid #ccc; z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }
  #msg {
    flex: 1; padding: 10px 14px;
    border-radius: 20px; border: 1px solid #ccc;
    font-size: 16px; outline: none; resize: none;
  }
  #msg:focus { border-color: #ff5f6d; }
  #send-btn, #clear-btn {
    padding: 10px 16px; border: none;
    background: linear-gradient(90deg, #ff5f6d, #ffc371);
    color: white; border-radius: 20px;
    font-size: 16px; cursor: pointer;
  }
  #send-btn:active, #clear-btn:active { opacity: 0.85; }
</style>
</head>
<body data-chat-id="1234">

<header>
  Agent Interface ðŸ’¬
  <div id="user-status">ðŸ”´</div>
</header>

<div id="typing-indicator" aria-live="polite"></div>
<div id="chat-container" aria-live="polite"></div>

<div id="input-container">
  <textarea id="msg" placeholder="Type reply..." rows="2" autocomplete="off"></textarea>
  <button id="send-btn">âž¤</button>
  <button id="clear-btn">Clear</button>
</div>

<script>
const BACKEND_URL = "https://chatbot-788207962975.us-central1.run.app";
const chatId = document.body.dataset.chatId || "1234";

const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-btn");
const chatContainer = document.getElementById("chat-container");
const userStatus = document.getElementById("user-status");
const typingIndicator = document.getElementById("typing-indicator");

async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  await fetch(`${BACKEND_URL}/send`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ chat_id: chatId, sender: "agent", text })
  });
  msgInput.value = "";
  await sendTyping("");
  loadMessages();
}

async function loadMessages(){
  const res = await fetch(`${BACKEND_URL}/messages/${chatId}`);
  if(!res.ok) return;
  const data = await res.json();
  chatContainer.innerHTML = "";
  data.forEach(m=>{
    const d=document.createElement("div");
    d.className="message "+(m.sender==="user"?"user-msg":"agent-msg");
    d.textContent=m.text;
    chatContainer.appendChild(d);
  });
  chatContainer.scrollTop=chatContainer.scrollHeight;
}

async function sendTyping(text){
  await fetch(`${BACKEND_URL}/live_typing`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ chat_id: chatId, sender:"agent", text })
  });
}

async function loadTyping(){
  const res=await fetch(`${BACKEND_URL}/get_live_typing/${chatId}`);
  if(!res.ok) return;
  const d=await res.json();
  typingIndicator.textContent=(d.sender==="user"&&d.text)?`User typing: ${d.text}`:"";
}

async function checkStatus(){
  const res=await fetch(`${BACKEND_URL}/is_online/${chatId}`);
  if(!res.ok) return;
  const d=await res.json();
  userStatus.textContent=d.user_online?"ðŸŸ¢":"ðŸ”´";
}

async function clearChat(){
  await fetch(`${BACKEND_URL}/clear_chat/${chatId}`, {method:"POST"});
  chatContainer.innerHTML="";
}

window.addEventListener("beforeunload", ()=>{
  const data=JSON.stringify({ chat_id: chatId, sender:"agent" });
  const blob=new Blob([data],{type:"application/json"});
  navigator.sendBeacon(`${BACKEND_URL}/logout_agent`, blob);
});

sendBtn.onclick=sendMessage;
clearBtn.onclick=clearChat;
msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMessage(); }
});
msgInput.addEventListener("input",e=>sendTyping(e.target.value));

setInterval(loadMessages,1000);
setInterval(checkStatus,1000);
setInterval(loadTyping,500);

checkStatus(); loadMessages(); loadTyping();
</script>
</body>
</html>
