<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>USER</title>

  <!-- Dialogflow CX Messenger -->
  <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, doc, onSnapshot, query, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // âœ… Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyABXXFFamtW5rjBZGqe-2uyR2CoWIyzDG4",
      authDomain: "project001-474715.firebaseapp.com",
      projectId: "project001-474715",
      storageBucket: "project001-474715.firebasestorage.app",
      messagingSenderId: "788207962975",
      appId: "1:788207962975:web:f9ff0a07f72df289cc84ea"
    };

    // âœ… Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ðŸ”¹ Detect current session (from dfMessenger)
    window.addEventListener("dfMessengerLoaded", function () {
      const dfMessenger = document.querySelector("df-messenger");
      let currentSessionId = null;

      dfMessenger.addEventListener("df-request-sent", async (event) => {
        const sessionId = dfMessenger._state?.sessionId;
        currentSessionId = sessionId;
        console.log("ðŸ†” Session ID:", sessionId);

        // Initialize session in Firestore if it doesn't exist
        await addDoc(collection(db, "sessions"), {
          id: sessionId,
          timestamp: new Date(),
          status: "active"
        });

        // Add user message to Firestore
        await addDoc(collection(db, "sessions", sessionId, "messages"), {
          message: event.detail.queryInput.text,
          sender: "user",
          timestamp: new Date()
        });

        // Start listening to Firestore messages
        const q = query(collection(db, "sessions", sessionId, "messages"), orderBy("timestamp"));
        onSnapshot(q, (snapshot) => {
          snapshot.docChanges().forEach(change => {
            if (change.type === "added") {
              const msg = change.doc.data();
              console.log("ðŸ”¥ New message:", msg);
              // If it's an agent message, display it
              if (msg.sender === "agent") {
                dfMessenger.renderCustomText(msg.message);
              }
            }
          });
        });
      });
    });
  </script>

  <style>
    df-messenger {
      z-index: 999;
      position: fixed;
      --df-messenger-font-color: #000;
      --df-messenger-font-family: Google Sans;
      --df-messenger-chat-background: #f3f6fc;
      --df-messenger-message-user-background: #d3e3fd;
      --df-messenger-message-bot-background: #fff;
      bottom: 16px;
      right: 16px;
    }
  </style>
</head>

<body>
  <df-messenger
    location="us-central1"
    project-id="project001-474715"
    agent-id="f82d4b5f-ee2f-402c-8aa6-cb11b0a8e56d"
    language-code="en"
    max-query-length="-1">
    <df-messenger-chat-bubble chat-title="Support Bot"></df-messenger-chat-bubble>
  </df-messenger>
</body>
</html>
