<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Chat ðŸ’–</title>
<style>
  body { font-family: Arial; margin:0; display:flex; flex-direction:column; height:100vh; }
  header { background:#ff5f6d; color:white; padding:10px; text-align:center; font-weight:bold; }
  #agent-status { position:absolute; right:10px; top:10px; }
  #typing-indicator { font-style:italic; text-align:center; min-height:20px; color:#ff69b4; }
  #chat-container { flex:1; overflow-y:auto; padding:10px; }
  .message { margin:5px; padding:8px; border-radius:8px; max-width:70%; }
  .user-msg { background:#ffc0cb; align-self:flex-end; }
  .agent-msg { background:#eee; align-self:flex-start; }
  #input-container { display:flex; padding:10px; border-top:1px solid #ccc; }
  textarea { flex:1; resize:none; border-radius:10px; padding:8px; }
  button { margin-left:5px; padding:8px 12px; background:#ff5f6d; color:white; border:none; border-radius:10px; }
</style>
</head>
<body data-chat-id="1234">
<header>User ðŸ’– <span id="agent-status">ðŸ”´</span></header>
<div id="typing-indicator"></div>
<div id="chat-container"></div>
<div id="input-container">
  <textarea id="msg" rows="2"></textarea>
  <button id="send-btn">Send</button>
</div>
<script>
const BACKEND_URL="https://chatbot-788207962975.us-central1.run.app";
const chatId=document.body.dataset.chatId;
const msgInput=document.getElementById("msg");
const chat=document.getElementById("chat-container");
const typing=document.getElementById("typing-indicator");
const agentStatus=document.getElementById("agent-status");

async function sendMessage(){
  const text=msgInput.value.trim(); if(!text) return;
  await fetch(`${BACKEND_URL}/send`,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,sender:"user",text})});
  msgInput.value=""; await sendTyping("");
  loadMessages();
}
async function loadMessages(){
  const res=await fetch(`${BACKEND_URL}/messages/${chatId}`); const data=await res.json();
  chat.innerHTML=""; data.forEach(m=>{
    const d=document.createElement("div");
    d.className="message "+(m.sender==="user"?"user-msg":"agent-msg");
    d.textContent=m.text; chat.appendChild(d);
  }); chat.scrollTop=chat.scrollHeight;
}
async function sendTyping(text){
  await fetch(`${BACKEND_URL}/live_typing`,{method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId,sender:"user",text})});
}
async function checkTyping(){
  const res=await fetch(`${BACKEND_URL}/get_live_typing/${chatId}`); const d=await res.json();
  typing.textContent=(d.sender==="agent"&&d.text)?"Agent is typing...":"";
}
async function checkStatus(){
  const res=await fetch(`${BACKEND_URL}/is_online/${chatId}`); const d=await res.json();
  agentStatus.textContent=d.agent_online?"ðŸŸ¢":"ðŸ”´";
}
msgInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});
msgInput.addEventListener("input",e=>sendTyping(e.target.value));
document.getElementById("send-btn").onclick=sendMessage;
setInterval(loadMessages,1000);
setInterval(checkStatus,1000);
setInterval(checkTyping,500);
</script>
</body>
</html>
