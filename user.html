<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CCAI User Chatbot</title>

  <!-- âœ… Dialogflow CX Messenger -->
  <link rel="stylesheet" href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css">
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <!-- âœ… Firebase SDK (v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // ðŸ”¹ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyABXXFFamtW5rjBZGqe-2uyR2CoWIyzDG4",
      authDomain: "project001-474715.firebaseapp.com",
      projectId: "project001-474715",
      storageBucket: "project001-474715.firebasestorage.app",
      messagingSenderId: "788207962975",
      appId: "1:788207962975:web:f9ff0a07f72df289cc84ea"
    };

    // ðŸ”¹ Initialize Firebase + Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ðŸ”¹ Wait for chatbot to load
    window.addEventListener("dfMessengerLoaded", () => {
      const dfMessenger = document.querySelector("df-messenger");

      // Trigger when user sends a message
      dfMessenger.addEventListener("df-request-sent", () => {
        const sessionId = dfMessenger._state?.sessionId;
        console.log("ðŸ†” Session ID:", sessionId);

        // âœ… Listen to Firestore for live chat updates
        if (!sessionId) return;
        const q = query(collection(db, "sessions", sessionId, "messages"), orderBy("timestamp"));
        onSnapshot(q, (snapshot) => {
          console.clear();
          console.log("ðŸ”¥ Firestore messages:");
          snapshot.forEach((doc) => console.log(doc.data()));
        });
      });
    });
  </script>

  <style>
    body {
      margin: 0;
      background: #f5f7fa;
      font-family: "Google Sans", Arial, sans-serif;
    }

    df-messenger {
      z-index: 999;
      position: fixed;
      bottom: 16px;
      right: 16px;

      --df-messenger-font-color: #000;
      --df-messenger-font-family: Google Sans;
      --df-messenger-chat-background: #f3f6fc;
      --df-messenger-message-user-background: #d3e3fd;
      --df-messenger-message-bot-background: #fff;
      --df-messenger-send-icon: #1a73e8;
      --df-messenger-chat-bubble-icon: #1a73e8;
    }
  </style>
</head>

<body>
  <!-- ðŸ”¹ Dialogflow Messenger -->
  <df-messenger
    location="us-central1"
    project-id="project001-474715"
    agent-id="f82d4b5f-ee2f-402c-8aa6-cb11b0a8e56d"
    language-code="en"
    max-query-length="-1">
    <df-messenger-chat-bubble chat-title="Support Bot"></df-messenger-chat-bubble>
  </df-messenger>
</body>
</html>
