<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heart to Heart ðŸ’–</title>
<style>
html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  font-family: Arial, sans-serif;
  background: #f4f7f9;
  display: flex;
  flex-direction: column;
}

header {
  background: linear-gradient(90deg, #ff5f6d, #ffc371, #ff9a9e, #f77062);
  color: white;
  padding: 12px;
  text-align: center;
  font-size: 20px;
  font-weight: bold;
  border-bottom: 2px solid #ff9a9e;
  border-radius: 0 0 15px 15px;
}

#agent-status {
  font-weight: bold;
  color: #333;
  text-align: center;
  margin-top: 6px;
}

#ticket-status {
  text-align: center;
  font-size: 14px;
  color: #333;
  margin-top: 6px;
}

#chat-container {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  padding: 10px;
  overflow-y: auto;
}

.message {
  max-width: 80%;
  margin: 4px 0;
  padding: 8px 12px;
  border-radius: 12px;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.seen-indicator {
  display: block;
  font-size: 12px;
  color: #666;
  margin-top: 4px;
  text-align: right;
}

.user-msg { background: #ffc0cb; align-self: flex-end; }
.agent-msg { background: #ffffff; border: 1px solid #ddd; align-self: flex-start; }

#input-container {
  flex-shrink: 0;
  display: flex;
  padding: 10px;
  background: #fff;
  border-top: 1px solid #ccc;
}

#msg {
  flex: 1;
  padding: 8px 12px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 14px;
  resize: none;
}

#send-btn {
  margin-left: 8px;
  padding: 8px 16px;
  border: none;
  background: linear-gradient(90deg, #ff5f6d, #ffc371);
  color: white;
  border-radius: 20px;
  font-size: 14px;
  cursor: pointer;
}

#send-btn:active { opacity: 0.8; }
</style>
</head>
<body>
<div id="agent-status">Checking agent status...</div>
<div id="ticket-status">Ticket: Unread</div>
<header>Heart to Heart ðŸ’–</header>
<div id="chat-container"></div>

<div id="input-container">
  <textarea id="msg" placeholder="Type message..." rows="2"></textarea>
  <button id="send-btn" type="button">Send</button>
</div>

<script>
const baseUrl = "https://chatbot-788207962975.us-central1.run.app";
const chatId = "1234";
const localRole = 'user';

const msgInput = document.getElementById("msg");
const chatContainer = document.getElementById("chat-container");
const ticketStatusEl = document.getElementById('ticket-status');

let lastMessageCount = 0;

// ---------- Append message ----------
function appendMessage(msg, index) {
  // Avoid duplicate messages
  if (chatContainer.querySelector(`[data-index='${index}']`)) return;

  const div = document.createElement("div");
  div.className = "message " + (msg.sender === "user" ? "user-msg" : "agent-msg");
  div.textContent = msg.text;
  div.dataset.index = index;

  // Seen indicator
  if (msg.seen_by && msg.seen_by.includes('agent')) {
    const span = document.createElement('span');
    span.className = 'seen-indicator';
    span.textContent = 'Seen';
    div.appendChild(span);
  }

  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ---------- Load messages ----------
async function loadMessages() {
  const res = await fetch(`${baseUrl}/messages/${chatId}`);
  const data = await res.json();

  for (let i = 0; i < data.length; i++) {
    appendMessage(data[i], i);
  }
  lastMessageCount = data.length;
}

// ---------- Send message ----------
async function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;

  await fetch(`${baseUrl}/send`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ chat_id: chatId, sender: "user", text })
  });

  appendMessage({ sender: "user", text, seen_by: [] }, lastMessageCount);
  lastMessageCount++;
  msgInput.value = "";

  ticketStatusEl.textContent = 'Ticket: Unread';
  msgInput.focus();
}

// ---------- Show Seen ----------
function showSeen(index) {
  const el = chatContainer.querySelector(`[data-index='${index}']`);
  if (!el) return;
  if (!el.querySelector('.seen-indicator')) {
    const span = document.createElement('span');
    span.className = 'seen-indicator';
    span.textContent = 'Seen';
    el.appendChild(span);
  }
  ticketStatusEl.textContent = 'Ticket: Read âœ…';
}

// ---------- SSE for new messages and seen ----------
const es = new EventSource(`${baseUrl}/events/${chatId}`);
es.onmessage = e => {
  try {
    const data = JSON.parse(e.data);
    if (data.type === 'new_message') {
      appendMessage(data.message, lastMessageCount);
      lastMessageCount++;
    } else if (data.type === 'read') {
      const other = 'agent';
      if (data.seen_by.includes(other)) {
        showSeen(data.index);
      }
    }
  } catch(err) {}
};

// ---------- Check agent online ----------
async function checkAgent() {
  const res = await fetch(`${baseUrl}/is_online/${chatId}`);
  const data = await res.json();
  document.getElementById("agent-status").textContent =
    data.online ? "Agent Online ðŸŸ¢" : "Agent Offline ðŸ”´";
}

// ---------- Event listeners ----------
document.getElementById("send-btn").addEventListener("click", sendMessage);
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// ---------- Intervals ----------
setInterval(checkAgent, 2000);

// ---------- Logout ----------
window.addEventListener("beforeunload", () => {
  navigator.sendBeacon(`${baseUrl}/logout_user`, JSON.stringify({ chat_id: chatId }));
});

// ---------- Initial load ----------
loadMessages();
checkAgent();
</script>
</body>
</html>
