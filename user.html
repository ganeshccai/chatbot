<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Heart to Heart ðŸ’–</title>
<style>
html, body { height:100%; margin:0; padding:0; font-family:Arial,sans-serif; background:#f4f7f9; display:flex; flex-direction:column; }
header { background:linear-gradient(90deg,#ff5f6d,#ffc371,#ff9a9e,#f77062); color:white; padding:12px; text-align:center; font-size:20px; font-weight:bold; border-bottom:2px solid #ff9a9e; border-radius:0 0 15px 15px; }
#agent-status { font-weight:bold; color:#333; text-align:center; margin-top:6px; }
#ticket-status { text-align:center; font-size:14px; color:#333; margin-top:6px; }
#chat-container { flex:1 1 auto; display:flex; flex-direction:column; padding:10px; overflow-y:auto; }
.message { max-width:80%; margin:4px 0; padding:8px 12px; border-radius:12px; word-wrap:break-word; white-space:pre-wrap; }
.seen-indicator { display:block; font-size:12px; color:#666; margin-top:4px; text-align:right; }
.user-msg { background:#ffc0cb; align-self:flex-end; }
.agent-msg { background:#ffffff; border:1px solid #ddd; align-self:flex-start; }
#input-container { flex-shrink:0; display:flex; padding:10px; background:#fff; border-top:1px solid #ccc; }
#msg { flex:1; padding:8px 12px; border-radius:20px; border:1px solid #ccc; font-size:14px; resize:none; }
#send-btn { margin-left:8px; padding:8px 16px; border:none; background:linear-gradient(90deg,#ff5f6d,#ffc371); color:white; border-radius:20px; font-size:14px; cursor:pointer; }
#send-btn:active { opacity:0.8; }
</style>
</head>
<body>
<div id="agent-status">Checking agent status...</div>
<div id="ticket-status">Ticket: Unread</div>
<header>Heart to Heart ðŸ’–</header>
<div id="chat-container"></div>
<div id="input-container">
  <textarea id="msg" placeholder="Type message..." rows="2" enterkeyhint="enter"></textarea>
  <button id="send-btn" type="button">Send</button>
</div>

<script>
const baseUrl = "https://chatbot-788207962975.us-central1.run.app";
const chatId = "1234";
const localRole = 'user';

const msgInput = document.getElementById("msg");
const chatContainer = document.getElementById("chat-container");
const ticketStatusEl = document.getElementById('ticket-status');

let renderedIndexes = new Set();
let ticketRead = false;
let _lastObservedMsg = null;

// IntersectionObserver for marking read
const _observer = new IntersectionObserver(entries => {
  for (const entry of entries) {
    if (entry.isIntersecting) markTicketRead('user');
  }
}, { root: chatContainer, threshold: 0.9 });

function observeLastMessage(shouldObserve) {
  if (_lastObservedMsg) _observer.unobserve(_lastObservedMsg);
  _lastObservedMsg = null;
  if (!shouldObserve) return;
  const last = chatContainer.lastElementChild;
  if (last) { _observer.observe(last); _lastObservedMsg = last; }
}

function markTicketRead(reader) {
  if (ticketRead) return;
  ticketRead = true;
  ticketStatusEl.textContent = 'Ticket: Read âœ…';
  fetch(`${baseUrl}/mark_read`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({chat_id:chatId, reader})
  }).catch(()=>{});
}

function showSeenIndicator(index) {
  const el = chatContainer.querySelector(`[data-index='${index}']`);
  if (!el || el.querySelector('.seen-indicator')) return;
  const span = document.createElement('span');
  span.className = 'seen-indicator';
  span.textContent = 'Seen';
  el.appendChild(span);
}

// Load messages
async function loadMessages() {
  const res = await fetch(`${baseUrl}/messages/${chatId}`);
  const data = await res.json();
  const inputFocused = document.activeElement === msgInput;

  data.forEach((msg,i)=>{
    if (!renderedIndexes.has(i)) {
      const div = document.createElement("div");
      div.className = "message " + (msg.sender==="user"?"user-msg":"agent-msg");
      div.textContent = msg.text;
      div.dataset.index = i;
      chatContainer.appendChild(div);
      renderedIndexes.add(i);
    }
  });

  chatContainer.scrollTop = chatContainer.scrollHeight;

  if (inputFocused) { msgInput.focus(); const len=msgInput.value.length; try{msgInput.setSelectionRange(len,len);}catch(e){} }

  if (data.length>0){
    const lastMsg = data[data.length-1];
    const other='agent';
    if (lastMsg.seen_by && lastMsg.seen_by.includes(other)){
      ticketRead=true; ticketStatusEl.textContent='Ticket: Read âœ…';
      showSeenIndicator(data.length-1);
    } else if (!ticketRead){
      ticketStatusEl.textContent='Ticket: Unread';
      const lastEl = chatContainer.querySelector(`[data-index='${data.length-1}']`);
      if (lastEl && lastEl.querySelector('.seen-indicator')) lastEl.querySelector('.seen-indicator').remove();
    }
    observeLastMessage(lastMsg.sender!==localRole);
  } else observeLastMessage(false);
}

// Send user message
async function sendMessage() {
  const message = msgInput.value.trim();
  if (!message) return;

  await fetch(`${baseUrl}/send`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({chat_id:chatId, sender:"user", text:message})
  });

  const div = document.createElement("div");
  div.className = "message user-msg";
  div.textContent = message;
  const newIndex = renderedIndexes.size;
  div.dataset.index = newIndex;
  chatContainer.appendChild(div);
  renderedIndexes.add(newIndex);
  chatContainer.scrollTop = chatContainer.scrollHeight;

  msgInput.value="";
  msgInput.focus();
  observeLastMessage(false);
  ticketRead=false;
  ticketStatusEl.textContent='Ticket: Unread';
}

// SSE for read notifications
try {
  const es = new EventSource(`${baseUrl}/events/${chatId}`);
  es.onmessage = e=>{
    try{
      const payload=JSON.parse(e.data);
      const other='agent';
      if (payload.type==='read' && payload.seen_by && payload.seen_by.includes(other)){
        showSeenIndicator(payload.index);
        ticketRead=true;
        ticketStatusEl.textContent='Ticket: Read âœ…';
      }
    }catch(err){}
  };
}catch(err){}

// Check agent status
async function checkAgentStatus(){
  const res = await fetch(`${baseUrl}/is_online/${chatId}`);
  const data = await res.json();
  document.getElementById("agent-status").textContent = data.online ? "Agent Online ðŸŸ¢":"Agent Offline ðŸ”´";
}

// Live typing
async function sendLiveTyping(){
  await fetch(`${baseUrl}/live_typing`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ chat_id: chatId, text: msgInput.value })
  });
}

// Event listeners
document.getElementById("send-btn").addEventListener("click", sendMessage);
msgInput.addEventListener("keydown", e=>{if(e.key==="Enter"){if(e.ctrlKey||e.metaKey){e.preventDefault();sendMessage();}}});

// Logout user
window.addEventListener("beforeunload", ()=>{navigator.sendBeacon(`${baseUrl}/logout_user`, JSON.stringify({ chat_id: chatId }));});

// Intervals
setInterval(loadMessages,1500);
setInterval(sendLiveTyping,500);
setInterval(checkAgentStatus,2000);

loadMessages();
checkAgentStatus();
</script>
</body>
</html>
