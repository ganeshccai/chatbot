<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>User Chat</title>
  <style>
    :root {
      --accent: #10b981;
      --accent2: #059669;
      --bg: #f3f6fb;
      --bubble-user: #d1fae5;
      --bubble-agent: #ffffff;
      --agent-border: #dcdcdc;
    }
    html, body { height:100%; margin:0; padding:0; overflow:hidden; }
    body { font-family: Arial, sans-serif; display:flex; flex-direction:column; background:var(--bg); }
    header { background:linear-gradient(90deg,var(--accent),var(--accent2)); color:white; padding:12px; text-align:center; font-weight:bold; position:relative; }
    #agent-status { position:absolute; right:12px; top:12px; font-weight:bold; }
    #typing-indicator { font-style:italic; text-align:center; min-height:24px; color:#059669; background:#fff; padding:6px 8px; border-bottom:1px solid #eee; }
    #chat-container { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; }
    .message { margin:6px 0; padding:10px 14px; border-radius:14px; max-width:80%; word-wrap:break-word; }
    .user-msg { background:var(--bubble-user); align-self:flex-end; }
    .agent-msg { background:var(--bubble-agent); border:1px solid var(--agent-border); align-self:flex-start; }
    #input-container { display:flex; gap:8px; padding:10px; background:#fff; border-top:1px solid #ccc; }
    #msg { flex:1; resize:none; border-radius:14px; padding:10px 12px; border:1px solid #ccc; font-size:16px; outline:none; max-height:120px; }
    #msg:focus { border-color: var(--accent); }
    button { padding:10px 16px; background:var(--accent); color:white; border:none; border-radius:14px; cursor:pointer; font-size:16px; }
    button:active { opacity:0.9; }
  </style>
</head>
<body data-chat-id="1234">

<header>User ðŸ’¬ <span id="agent-status">ðŸ”´</span></header>
<div id="typing-indicator"></div>
<div id="chat-container"></div>
<div id="input-container">
  <textarea id="msg" rows="2" placeholder="Type message..." autocomplete="off"></textarea>
  <button id="send-btn">Send</button>
  <button id="clear-btn">Clear</button>
</div>

<script>
const BACKEND_URL = "https://chatbot-788207962975.us-central1.run.app";
const chatId = document.body.dataset.chatId || "1234";

const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send-btn");
const clearBtn = document.getElementById("clear-btn");
const chatContainer = document.getElementById("chat-container");
const typingIndicator = document.getElementById("typing-indicator");
const agentStatus = document.getElementById("agent-status");

let isLoggedIn = true;

startPolling();

function startPolling() {
  markOnline();
  checkStatus();
  loadMessages();
  loadTyping();
  setInterval(loadMessages, 1000);
  setInterval(checkStatus, 1000);
  setInterval(loadTyping, 500);
  setInterval(markOnline, 10000);
}

async function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;
  await fetch(`${BACKEND_URL}/send`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({chat_id: chatId, sender: "user", text})
  });
  msgInput.value = "";
  await sendTyping("");
  loadMessages();
}

async function loadMessages() {
  if (!isLoggedIn) return;
  const res = await fetch(`${BACKEND_URL}/messages/${chatId}?viewer=user`);
  const data = await res.json();
  chatContainer.innerHTML = "";

  data.forEach((m, i) => {
    const d = document.createElement("div");
    d.className = "message " + (m.sender === "user" ? "user-msg" : "agent-msg");
    d.innerHTML = (m.text || "").replace(/\n/g, "<br>");

    const isLast = i === data.length - 1;
    if (m.sender === "user" && m.seen_by === "agent" && isLast) {
      const seenTag = document.createElement("div");
      seenTag.style.fontSize = "12px";
      seenTag.style.color = "#888";
      seenTag.style.marginTop = "4px";
      seenTag.textContent = "Seen âœ…";
      d.appendChild(seenTag);
    }

    chatContainer.appendChild(d);
  });

  chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function sendTyping(text) {
  if (!isLoggedIn) return;
  await fetch(`${BACKEND_URL}/live_typing`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({chat_id: chatId, sender: "user", text})
  });
}

async function loadTyping() {
  if (!isLoggedIn) return;
  const res = await fetch(`${BACKEND_URL}/get_live_typing/${chatId}`);
  const d = await res.json();
  typingIndicator.textContent = (d.sender === "agent" && d.text) ? `Agent typing: ${d.text}` : "";
}

async function checkStatus() {
  if (!isLoggedIn) return;
  const res = await fetch(`${BACKEND_URL}/is_online/${chatId}?t=${Date.now()}`);
  const d = await res.json();
  agentStatus.textContent = d.agent_online ? "ðŸŸ¢" : "ðŸ”´";
}

async function clearChat() {
  if (!isLoggedIn) return;
  await fetch(`${BACKEND_URL}/clear_chat/${chatId}`, {method: "POST"});
  chatContainer.innerHTML = "";
}

async function markOnline() {
  if (!isLoggedIn) return;
  await fetch(`${BACKEND_URL}/mark_online`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({chat_id: chatId, sender: "user"})
  });
}

sendBtn.addEventListener("mousedown", e => e.preventDefault());
sendBtn.addEventListener("click", sendMessage);
clearBtn.addEventListener("click", clearChat);
msgInput.addEventListener("input", e => sendTyping(e.target.value));

window.addEventListener("beforeunload", () => {
  try {
    const data = JSON.stringify({chat_id: chatId});
    const blob = new Blob([data], {type: "application/json"});
    navigator.sendBeacon(`${BACKEND_URL}/logout_user`, blob);
  } catch (e) {}
});
</script>
</body>
</html>
